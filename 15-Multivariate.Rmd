# Multivariate random variables

## Sequential simulation

### Sequential MC for the AR(1)-process

Recall the update equation 
$$X_{t} = \alpha X_{t-1} + \epsilon_t.$$
and the observation equation
$$Y_t = X_t + \delta_t.$$
 
Simulating a sample path


```{r AR_sim_fun}
simAR <- function(t, alpha) {
  x <- numeric(t)
  e <- rnorm(t, 0, 1)
  x[1] <- e[1] / sqrt(1 - alpha^2)
  for(s in seq_len(t)[-1]) {
    x[s] <- alpha * x[s - 1] + e[s]
  }
  x
}
```

```{r AR_plot_labels, echo=FALSE}
tm <- data.frame(x = 1:5, y = 1:5, lab = c("Smooth", "Filter", "Y", "X", "Boot"))
```

Simulating a sample path

We first generate a realization from the process with $\alpha = 0.9$ and observation variance $\sigma^2 = 10$.

```{r AR_sim, echo=1:3, dependson="AR_sim_fun"}
t <- 100; alpha <- 0.9; sigma <- sqrt(10)
set.seed(30)
x <- simAR(t, alpha)
y <- rnorm(t, x, sigma)
p <- qplot(1:t, x, geom = "line") + 
  geom_point() 
```

The simulated sample path

```{r AR_fig, echo=FALSE, dependson=c("AR_sim", "AR_plot_labels")}
yl <- range(y) 
p <- p + ylim(yl) + ylab("")
p +  geom_point(data = tm[4, ], aes(x = x, y = y, color = lab), alpha = 0) + 
  scale_color_manual("", guide = guide_legend(override.aes = list(alpha = 1)),
                              values = c("black")) +
  theme(legend.position = c(0.08, 0.85))
```

Sample path with observations

```{r AR_fig2, echo=FALSE, dependson=c("AR_fig", "AR_plot_labels", "AR_sim")}
p + geom_point(aes(y = y), color = "green") + 
  geom_segment(aes(xend = 1:t, yend = y), linetype = 2, color = "green") +
  geom_point(data = tm[3:4, ], aes(x = x, y = y, color = lab), alpha = 0) + 
  scale_color_manual("", guide = guide_legend(override.aes = list(alpha = 1)),
                              values = c("black", "green")) +
  theme(legend.position = c(0.08, 0.85))
```

... and observations only

```{r AR_fig3, echo=FALSE, dependson=c("AR_plot_labels", "AR_sim")}
p2 <- qplot(1:t, y, color = I("green")) + ylim(yl) + ylab("")
p2 + geom_point(data = tm[3, ], aes(x = x, y = y, color = lab), alpha = 0) + 
  scale_color_manual("", guide = guide_legend(override.aes = list(alpha = 1)),
                              values = c("green")) +
  theme(legend.position = c(0.08, 0.85))
```

Using the Kalman smoother

We can use the implemented Kalman smoother and Kalman filter 
to compute the best prediction of the unobserved process.

```{r AR_Kalman, dependson="Rcpp_depends"}
xSmooth <- KalmanSmooth(y, alpha, sigma^2)
xFilt <- KalmanFilt(y, alpha, sigma^2)
```

Using the Kalman smoother

```{r AR_Kalman_smooth, echo=FALSE, dependson=c("AR_plot_labels", "AR_fig3", "AR_Kalman")}
p2 + geom_line(aes(y = xSmooth), color = "red") + 
  geom_point(aes(y = xSmooth), color = "red") + 
  geom_point(data = tm[c(1, 3), ], aes(x = x, y = y, color = lab), alpha = 0) + 
  scale_color_manual("", guide = guide_legend(override.aes = list(alpha = 1)),
                              values = c("red", "green")) +
  theme(legend.position = c(0.08, 0.85))
```

Using the Kalman filter only

```{r AR_Kalman_filt, echo=FALSE, dependson=c("AR_plot_labels", "AR_fig3", "AR_Kalman")}
p2 + geom_line(aes(y = xFilt), color = "blue") + 
  geom_point(aes(y = xFilt), color = "blue") + 
  geom_point(data = tm[c(2, 3), ], aes(x = x, y = y, color = lab), alpha = 0) + 
  scale_color_manual("", guide = guide_legend(override.aes = list(alpha = 1)),
                              values = c("blue", "green")) +
  theme(legend.position = c(0.08, 0.85))
```

Filter, smoother and process

```{r AR_Kalman_all, echo=FALSE, dependson=c("AR_plot_labels", "AR_fig", "AR_Kalman")}
p + geom_line(aes(y = xFilt), color = "blue") + 
  geom_point(aes(y = xFilt), color = "blue") + 
  geom_line(aes(y = xSmooth), color = "red") + 
  geom_point(aes(y = xSmooth), color = "red") + 
  geom_point(data = tm[c(1, 2, 4), ], aes(x = x, y = y, color = lab), alpha = 0) + 
  scale_color_manual("", guide = guide_legend(override.aes = list(alpha = 1)),
                     values = c("blue", "red", "black")) +
  theme(legend.position = c(0.08, 0.85))
```


      










## Gaussian random variables
